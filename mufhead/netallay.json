{
  "api_version": "0.19.0",
  "authors": [
    {
      "avatar_url": "https://avatars.githubusercontent.com/u/40874260?v=4",
      "name": "MufHead",
      "url": "https://github.com/MufHead"
    }
  ],
  "categories": [
    "utility"
  ],
  "created_at": 1769836674,
  "dependencies": [],
  "description": "# NetAllay\n\nNetAllay 是一个用于 AllayMC 服务器的网易 PyRpc 通信 API 插件，提供类似于 NukkitMaster 的通信接口，让插件开发者能够轻松地与网易版 Minecraft 客户端进行双向通信。\n\n## 功能特性\n\n- 监听客户端发送的 PyRpc 事件\n- 向单个/多个玩家发送服务端事件\n- 支持按位置范围广播事件\n- 支持按世界/维度广播事件\n- 自动处理 MsgPack 编解码\n- 线程安全的事件注册机制\n\n## 安装\n\n1. 下载 `NetAllay-x.x.x-shaded.jar`\n2. 将 jar 文件放入服务器的 `plugins` 目录\n3. 重启服务器\n\n## 作为前置依赖\n\n如果你的插件需要使用 NetAllay，需要在 `build.gradle.kts` 中添加依赖：\n\n```kotlin\ndependencies {\n    // 本地 jar 依赖\n    compileOnly(files(\"path/to/NetAllay-1.0.0-shaded.jar\"))\n}\n\nallay {\n    plugin {\n        // 声明插件依赖\n        dependency(\"NetAllay\")\n    }\n}\n```\n\n## API 使用\n\n### 获取实例\n\n```java\nimport org.allaymc.netallay.NetAllay;\n\n// 方式一：直接获取静态实例\nNetAllay netAllay = NetAllay.getInstance();\n\n// 方式二：通过插件管理器获取\nNetAllay netAllay = (NetAllay) Server.getInstance()\n    .getPluginManager()\n    .getPlugin(\"NetAllay\");\n```\n\n### 监听客户端事件\n\n使用 `listenForEvent` 方法注册事件监听器，当客户端发送匹配的事件时，回调函数会被调用。\n\n```java\nnetAllay.listenForEvent(\n    \"MyMod\",           // namespace - 客户端系统的命名空间\n    \"MySystemCS\",      // systemName - 客户端系统名称\n    \"OnButtonClick\",   // eventName - 事件名称\n    (player, data) -> {\n        // player - 发送事件的玩家\n        // data - 事件数据 (Map<String, Object>)\n\n        String buttonId = (String) data.get(\"buttonId\");\n        pluginLogger.info(\"玩家 {} 点击了按钮: {}\", player.getOriginName(), buttonId);\n    }\n);\n```\n\n### 取消监听\n\n```java\n// 取消特定处理器\nnetAllay.unlistenForEvent(namespace, systemName, eventName, handler);\n\n// 取消某个事件的所有处理器\nnetAllay.unlistenAllForEvent(namespace, systemName, eventName);\n```\n\n### 发送事件给单个玩家\n\n```java\nMap<String, Object> data = new LinkedHashMap<>();\ndata.put(\"message\", \"Hello from server!\");\ndata.put(\"timestamp\", System.currentTimeMillis());\n\nboolean success = netAllay.notifyToClient(\n    player,            // 目标玩家\n    \"MyMod\",           // namespace - 客户端监听的命名空间\n    \"MySystemSS\",      // systemName - 服务端系统名称\n    \"ServerMessage\",   // eventName - 事件名称\n    data               // 事件数据\n);\n```\n\n#### 立即发送（不缓冲）\n\n```java\nnetAllay.notifyToClientImmediately(player, namespace, systemName, eventName, data);\n```\n\n### 发送事件给多个玩家\n\n```java\nList<Player> players = Arrays.asList(player1, player2, player3);\n\nint successCount = netAllay.notifyToMultiClients(\n    players,\n    \"MyMod\",\n    \"MySystemSS\",\n    \"Announcement\",\n    Map.of(\"content\", \"服务器公告内容\")\n);\n```\n\n### 发送事件给附近玩家\n\n```java\nLocation3dc center = player.getControlledEntity().getLocation();\n\nint count = netAllay.notifyToClientsNearby(\n    null,              // except - 排除的玩家，可为 null\n    center,            // 中心位置\n    50.0,              // 半径（方块）\n    \"MyMod\",\n    \"MySystemSS\",\n    \"NearbyEvent\",\n    Map.of(\"type\", \"explosion\")\n);\n```\n\n### 广播事件\n\n#### 广播到指定世界（所有维度）\n\n```java\nWorld world = Server.getInstance().getWorldPool().getWorld(\"world\");\n\nnetAllay.broadcastToAllClient(\n    null,              // except - 排除的玩家\n    world,             // 目标世界\n    \"MyMod\",\n    \"MySystemSS\",\n    \"WorldEvent\",\n    data\n);\n```\n\n#### 广播到指定维度\n\n```java\nDimension dimension = world.getOverWorld();\n\nnetAllay.broadcastToAllClient(\n    exceptPlayer,      // 排除的玩家\n    dimension,         // 目标维度\n    \"MyMod\",\n    \"MySystemSS\",\n    \"DimensionEvent\",\n    data\n);\n```\n\n#### 广播到整个服务器\n\n```java\nnetAllay.broadcastToAllClient(\n    null,              // except - 排除的玩家\n    \"MyMod\",\n    \"MySystemSS\",\n    \"GlobalEvent\",\n    data\n);\n```\n\n## 数据类型支持\n\n事件数据 `Map<String, Object>` 支持以下值类型：\n\n| Java 类型 | 说明 |\n|-----------|------|\n| `null` | 空值 |\n| `Boolean` | 布尔值 |\n| `Integer` / `Long` | 整数 |\n| `Float` / `Double` | 浮点数 |\n| `String` | 字符串 |\n| `byte[]` | 二进制数据 |\n| `Map<String, Object>` | 嵌套对象 |\n| `List<?>` / `Iterable<?>` | 数组 |\n\n## 特殊常量\n\n### 本地玩家 Entity ID\n\n```java\n// 使用 -2 表示接收消息的玩家自己的实体\nNetAllay.LOCAL_PLAYER_ENTITY_ID  // 值为 -2\n```\n\n**注意：** 只能在 `notifyToClient` 中使用 -2，不要在广播方法中使用，因为 -2 对每个玩家代表不同的实体。\n\n## 完整示例\n\n```java\npackage com.example.myplugin;\n\nimport org.allaymc.api.eventbus.EventHandler;\nimport org.allaymc.api.eventbus.event.server.PlayerJoinEvent;\nimport org.allaymc.api.plugin.Plugin;\nimport org.allaymc.api.server.Server;\nimport org.allaymc.netallay.NetAllay;\n\nimport java.util.LinkedHashMap;\nimport java.util.Map;\n\npublic class MyPlugin extends Plugin {\n\n    @Override\n    public void onEnable() {\n        Server.getInstance().getEventBus().registerListener(this);\n\n        // 注册 PyRpc 事件监听\n        registerPyRpcHandlers();\n\n        pluginLogger.info(\"MyPlugin enabled!\");\n    }\n\n    private void registerPyRpcHandlers() {\n        NetAllay netAllay = NetAllay.getInstance();\n\n        // 监听客户端请求\n        netAllay.listenForEvent(\"MyMod\", \"MySystemCS\", \"RequestData\", (player, data) -> {\n            pluginLogger.info(\"收到来自 {} 的数据请求\", player.getOriginName());\n\n            // 构建响应数据\n            Map<String, Object> response = new LinkedHashMap<>();\n            response.put(\"success\", true);\n            response.put(\"playerName\", player.getOriginName());\n            response.put(\"serverTime\", System.currentTimeMillis());\n\n            // 发送响应\n            netAllay.notifyToClient(\n                player,\n                \"MyMod\",\n                \"MySystemSS\",\n                \"ResponseData\",\n                response\n            );\n        });\n\n        // 监听客户端操作\n        netAllay.listenForEvent(\"MyMod\", \"MySystemCS\", \"PerformAction\", (player, data) -> {\n            String action = (String) data.get(\"action\");\n\n            switch (action) {\n                case \"jump\" -> player.getControlledEntity().setMotion(0, 1, 0);\n                case \"heal\" -> player.getControlledEntity().setHealth(20);\n                default -> pluginLogger.warn(\"未知操作: {}\", action);\n            }\n        });\n    }\n\n    @EventHandler\n    public void onPlayerJoin(PlayerJoinEvent event) {\n        var player = event.getPlayer();\n\n        if (player.isNetEasePlayer()) {\n            // 向网易玩家发送欢迎消息\n            NetAllay.getInstance().notifyToClient(\n                player,\n                \"MyMod\",\n                \"MySystemSS\",\n                \"Welcome\",\n                Map.of(\n                    \"message\", \"欢迎来到服务器！\",\n                    \"entityId\", NetAllay.LOCAL_PLAYER_ENTITY_ID\n                )\n            );\n        }\n    }\n\n    @Override\n    public void onDisable() {\n        // 清理事件监听\n        NetAllay netAllay = NetAllay.getInstance();\n        if (netAllay != null) {\n            netAllay.unlistenAllForEvent(\"MyMod\", \"MySystemCS\", \"RequestData\");\n            netAllay.unlistenAllForEvent(\"MyMod\", \"MySystemCS\", \"PerformAction\");\n        }\n    }\n}\n```\n\n## 客户端对接\n\n在网易客户端 Mod 中，使用以下方式与服务端通信：\n\n### 监听服务端事件\n\n```python\n# Python 客户端示例\nimport mod.client.extraClientApi as clientApi\n\nClientSystem = clientApi.GetClientSystemCls()\n\nclass MyClientSystem(ClientSystem):\n    def __init__(self, namespace, systemName):\n        ClientSystem.__init__(self, namespace, systemName)\n        self.ListenForEvent(\"MyMod\", \"MySystemSS\", \"ServerMessage\", self, self.OnServerMessage)\n\n    def OnServerMessage(self, args):\n        message = args.get(\"message\")\n        print(\"收到服务端消息:\", message)\n```\n\n### 发送事件到服务端\n\n```python\ndef SendToServer(self, eventName, data):\n    self.NotifyToServer(\"MyMod\", \"MySystemSS\", eventName, data)\n\n# 使用\nself.SendToServer(\"RequestData\", {\"type\": \"player_info\"})\n```\n\n## 注意事项\n\n1. **线程安全**：NetAllay 的 API 是线程安全的，可以在任何线程调用\n2. **玩家检查**：发送前会自动检查玩家是否为网易客户端，非网易玩家会被跳过\n3. **广播限制**：在广播方法中不要使用 `-2` 作为 entityId\n4. **生命周期**：在插件禁用时记得取消注册的事件监听器\n5. **数据大小**：避免发送过大的数据包，建议单次数据不超过 64KB\n\n## 协议说明\n\nNetAllay 使用 MsgPack 格式编码数据，遵循网易 PyRpc 协议：\n\n- 服务端到客户端事件类型：`ModEventS2C`\n- 客户端到服务端事件类型：`ModEventC2S`\n- 字符串编码：UTF-8 Binary 格式\n\n## License\n\nMIT License\n",
  "downloads": 0,
  "gallery": [],
  "icon_url": "https://avatars.githubusercontent.com/u/40874260?v=4",
  "id": "mufhead/netallay",
  "license": {
    "id": "ARR",
    "name": "All Rights Reserved",
    "url": ""
  },
  "links": {
    "discord": "",
    "homepage": "https://github.com/YiRanKuma/NetAllay",
    "wiki": ""
  },
  "name": "NetAllay",
  "server_version": "",
  "source": "https://github.com/MufHead/NetAllay",
  "stars": 2,
  "summary": "基于Allay服务端制作的与网易我的世界客户端通信插件",
  "updated_at": 1769928467,
  "versions": []
}